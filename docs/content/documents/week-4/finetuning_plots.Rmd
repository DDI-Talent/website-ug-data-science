---
title: "Fine-tuning plots"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning = FALSE, 
                      fig.width=5, fig.height=4)
```

# Data and initial plot

We will be using the `gapminder` dataset:

```{r}
library(tidyverse)
library(gapminder)

mydata <- gapminder

mydata %>% 
  glimpse()
```

We can save a `ggplot()` object into a variable (usually called `p` but can be any name). This then appears in the Environment tab. To plot it we need to recalled it on a separate line. Saving a plot into a variable allows us to modify it later (e.g., `p + theme_bw()`).

```{r}
p <- mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(y = lifeExp, x = gdpPercap, colour = continent)) +
  geom_point(alpha = 0.3) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set1") 

p 
```

# Scales

## Logarithmic

```{r}

p + scale_x_log10()


```

## Expand limits

Specify the value you want to be included:

```{r}

p + expand_limits(y = 0)

```

\newpage 

Or two:

```{r}

p + expand_limits(y = c(0, 100))

```

By default, `ggplot` adds some padding around the included area (see how the scale doesn't start from 0, but slightly before). You can remove this padding with the expand option:

```{r}

p + expand_limits(y = c(0, 100)) +
  coord_cartesian(expand = FALSE)

```


## Zoom in

We can use `coord_cartesian()` to zoom in on a specific part of our plot:

```{r}

p + coord_cartesian(ylim = c(70,85), xlim = c(20000, 40000))

```


### Exercise

How is this one different to the previous:

```{r}

p + scale_y_continuous(limits = c(70, 85)) +
  scale_x_continuous(limits = c(20000, 40000))
```

Answer: the first one zooms in, still retaining information about the excluded points when calculating the linear regression lines. The second one removes the data (as the warnings say), calculating the linear regression lines only for the visible points.

## Axis ticks

```{r}

p + coord_cartesian(ylim = c(0, 100), expand = 0) +
  scale_y_continuous(breaks = c(17, 35, 88)) 
```


## Swap the axes

```{r}

p + coord_flip()

```


# Colours

## Using the Brewer palettes:

```{r}

p + scale_color_brewer(palette = "Paired")

```


## Legend title

`scale_colour_brewer()` is also a conventient place to change the legend title:

```{r}

p + scale_color_brewer("Continent - \n one of 5", palette = "Paired")

```

Note the `\n` inside the new legend title - new line.

## Choosing colours manually

Use words:

```{r}

p + scale_color_manual(values = c("hotpink", "darkgreen",
                                  "mediumpurple2", "skyblue2",
                                  "firebrick3"))

```

Or HEX codes (either from http://colorbrewer2.org/ or any other resource):


```{r}

p + scale_color_manual(values = c("#e41a1c", "#377eb8", "#4daf4a",
                                  "#984ea3", "#ff7f00"))

```


Note that http://colorbrewer2.org/ also has options for *Colourblind safe* and *Print friendly*.

## Other fun palettes 

**Note:** you will need to install the following packages using `install.packages()`. Uncomment the lines of code below to do this. Remember, though, that you only every need to install a package once. 

There are many other fun color palettes and packages. Two of my favorite are:

* `wesanderson` package by Karthik Ram, which currently includes 16 palettes from various Wes Anderson movies (https://github.com/karthik/wesanderson#readme)


```{r}
#install.packages("wesanderson")
library(wesanderson)
p + scale_color_manual(values = wes_palette("Royal2", n = 5))
```

* `nationalparkcolors` package by Katie Jolly, which offers 25 palettes from different [US National Parks posters](https://github.com/katiejolly/nationalparkcolors)


```{r}
#install.packages("devtools")
#devtools::install_github("katiejolly/nationalparkcolors")
library(nationalparkcolors)
p + scale_color_manual(values = park_palette("Saguaro", 5)) 

```

**Note**: Try to use `+ scale_fill_manual` in either of the examples above. What happens? - Nothing. If you look back at our original code for the plot `p` notice that we have *not* mapped fill to any variable, but rather used colour (hence the warning message that R is replacing the Brewer colour scale we originally specified). If we had specified `fill = variable` in the `aes()`, then we would want to use `+ scale_fill_manual`. 

\newpage 

# Titles and labels

When creating figures for reports or publication, it is important to remember to change axis labels from what the variables are called in the dataset to something informative to any viewer. Using the `labs()` function, you can also change the name of the legend here. The argument depends on what you specified in the `aes()` (e.g., `fill`, `colour`, `size`, etc.)

Check the documentation of the `labs()` function to see all of the different possible arguments. As with most things in R, there is more than 1 way to change figure labels or to add a title. To change the x or y axis labels only, you could use `xlab()` or `ylab()` and for titles there is a function called `ggtitle()`. 

```{r}
?labs 

p + labs(x = "Gross domestic product per capita",
         y = "Life expectancy",
         colour = "Continent",
         title = "Health and economics",
         subtitle = "Gapminder dataset, 2007")

```


## Annotation


```{r}

p + annotate("text",
             x = 25000,
             y = 50,
             label = "No points here!")

```


```{r}

p + annotate("label",
             x = 25000,
             y = 50,
             label = "No points here!")

```



```{r}

p + annotate("label",
             x = 25000,
             y = 50,
             label = "No points here!", 
             hjust = 0)

```


`hjust` stands for horizontal justification. It's default value is 0.5 (see how the label was centered at 25,000 - our chosen x location), 0 means the label goes to the right from 25,000, 1 would make it end at 25,000.


## Annotation with a superscript and a variable

```{r}

fit_glance <- data.frame(r.squared = 0.7693465)


plot_rsquared <- paste0(
  "R^2 == ",
  fit_glance$r.squared %>% round(2))


p + annotate("text",
             x = 25000,
             y = 50,
             label = plot_rsquared, parse = TRUE,
             hjust = 0)

```

# Text size



```{r}

p + theme(axis.text.y = element_text(size = 16),
          axis.text.x = element_text(colour = "purple", 
                                     angle = 45, vjust = 0.5),
          axis.title = element_text(size = 16, colour = "darkgreen"))

```


## Legend position


Use the following words: `"right", "left", "top", "bottom"`, or `"none"` to remove the legend.
```{r}

p + theme(legend.position = "none")

```

Or use relative coordinates (0--1) to give it an -y location:

```{r}

p + theme(legend.position=c(1,0),
          legend.justification=c(1,0)) #bottom-right corner

```



```{r}

p + theme(legend.position = "top") +
  guides(colour = guide_legend(ncol=2))

```


# Combining Multiple Plots 

Sometimes you may want to put two or more ggplots together in the same graphic/plot space, which is there `patchwork` package comes in to save the day! 

You can learn more about the `patchwork` package [on their website](https://patchwork.data-imaginist.com/) 

```{r fig.height=6, fig.width=8}
#install.packages("patchwork")
library(patchwork)

p57 <- mydata %>% 
  filter(year == 1957) %>% 
  ggplot(aes(y = lifeExp, x = gdpPercap, colour = continent)) +
  geom_point(alpha = 0.3) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set1") + 
  labs(title = "1957", 
       x = "Gross domestic product per capita",
       y = "Life expectancy")

p07 <- p + labs(title = "2007",
               x = "Gross domestic product per capita",
               y = "Life expectancy")

p57 + p07
```

The two plots are now combined, but the legends are repeated. If we tell `patchwork` that the legends are the same for both plots, we can create a more professional and legible presentation. 

```{r fig.height=6, fig.width=8}
p57 + p07 + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
```

Often in journal articles or reports, multiple plots are collected in a single figure and referred to by a tag. 

```{r fig.height=6, fig.width=8}
p57 + p07 + plot_annotation(title = "Health and economics",
                            subtitle = "Gapminder dataset", 
                            tag_levels = "A") + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')
```

You can find more information about annotating and styling composite figures using `patchwork` [here](https://patchwork.data-imaginist.com/articles/guides/annotation.html)


# Saving your plot

You can save your plot using the `ggsave()` function, specifying which plot to save, the file nice, and what the figure dimensions should be. 

```{r}
ggsave(p, file = "my_saved_plot.png", width = 5, height = 4)
```


# Optional Exercise 
Try to produce a graphic with a plot for 1957, 1977, 1987, and 2007 in the dataset. A solution is provided at the end of this document, but try it on your own before peaking! 

```{r}
# your R code:

```


## Solution - Optional Exercise 

```{r fig.height=6, fig.width=5, message=FALSE}
## first make the different plots 
## above we already have p07 and p57 

p77 <- mydata %>% 
  filter(year == 1977) %>% 
  ggplot(aes(y = lifeExp, x = gdpPercap, colour = continent)) +
  geom_point(alpha = 0.3) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set1") + 
  labs(title = "1977", 
       x = "Gross domestic product per capita",
       y = "Life expectancy")

p87 <- mydata %>% 
  filter(year == 1987) %>% 
  ggplot(aes(y = lifeExp, x = gdpPercap, colour = continent)) +
  geom_point(alpha = 0.3) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set1") + 
  labs(title = "1987", 
       x = "Gross domestic product per capita",
       y = "Life expectancy")

## then combine them using patchwork 
p57 + p77 + p87 + p07 +  
  plot_annotation(title = "Health and economics",
                  subtitle = "Gapminder dataset", 
                  tag_levels = "A") + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

## another option - which is more useful to use when you have more than 4 plots. 
(p57 + p77) / (p87 + p07) +  
  plot_annotation(title = "Health and economics",
                  subtitle = "Gapminder dataset", 
                  tag_levels = "I") + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

```

Note `patchwork` uses the same operators that R does (e.g., `+` or `/` or `|`). For more details on plot assembly options [check out this webpage](https://patchwork.data-imaginist.com/articles/guides/assembly.html) 

For even more control over layouts beyond `+`, `/`, and `|`, look at [this webpage](https://patchwork.data-imaginist.com/articles/guides/layout.html)



